<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ferremas - Usuarios y Productos</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f4f9;
    color: #333;
    margin: 0; padding: 0;
  }
  .container {
    max-width: 600px;
    margin: 40px auto;
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  h2 {
    text-align: center;
    color: #4CAF50;
  }
  label, input, button {
    display: block;
    width: 100%;
    margin: 10px 0;
    box-sizing: border-box;
  }
  input {
    padding: 10px;
    font-size: 16px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 12px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 5px;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #45a049;
  }
  .alert {
    text-align: center;
    color: red;
    font-weight: bold;
    margin-top: 10px;
  }
  ul {
    list-style: none;
    padding: 0;
  }
  li {
    background: #e8f5e9;
    margin-bottom: 8px;
    padding: 10px;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .btn-small {
    background-color: #388E3C;
    color: white;
    border: none;
    padding: 6px 12px;
    margin-left: 8px;
    font-size: 14px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .btn-small:hover {
    background-color: #2E7D32;
  }
</style>
</head>
<body>

<!-- LOGIN / REGISTRO -->
<div class="container" id="loginRegistroContainer">
  <h2>Registro de Usuario</h2>
  <form id="registroForm">
    <label for="nombre">Nombre:</label>
    <input type="text" id="nombre" required />
    <label for="emailReg">Email:</label>
    <input type="email" id="emailReg" required />
    <label for="passwordReg">Contraseña:</label>
    <input type="password" id="passwordReg" required />
    <button type="submit">Registrar</button>
  </form>
  <h2>O Inicia Sesión</h2>
  <form id="loginForm">
    <label for="emailLog">Email:</label>
    <input type="email" id="emailLog" required />
    <label for="passwordLog">Contraseña:</label>
    <input type="password" id="passwordLog" required />
    <button type="submit">Iniciar Sesión</button>
  </form>
  <div class="alert" id="loginRegistroMessage"></div>
</div>

<!-- CRUD PRODUCTOS -->
<div class="container" id="productosContainer" style="display:none;">
  <button id="btnCerrarSesion" style="float:right; background:#d9534f;">Cerrar Sesión</button>
  <h2>Agregar Producto</h2>
  <form id="productForm">
    <label for="name">Nombre del producto:</label>
    <input type="text" id="name" name="name" required />
    <label for="price">Precio:</label>
    <input type="number" step="0.01" id="price" name="price" required />
    <button type="submit">Agregar</button>
  </form>
  <div class="alert" id="message"></div>

  <h2>Lista de Productos</h2>
  <button id="btnLoad">Cargar Productos</button>
  <ul id="productList"></ul>
</div>

<script>
  const apiUrl = 'http://127.0.0.1:5000';
  let usuarioLogueado = null;

  // Función para mostrar mensajes
  function showMessage(id, msg, color = "red") {
    const el = document.getElementById(id);
    el.style.color = color;
    el.textContent = msg;
  }
  function clearMessages() {
    showMessage('loginRegistroMessage', '');
    showMessage('message', '');
  }

  // Registro de usuario
  document.getElementById('registroForm').addEventListener('submit', e => {
    e.preventDefault();
    clearMessages();

    const nombre = document.getElementById('nombre').value.trim();
    const email = document.getElementById('emailReg').value.trim();
    const password = document.getElementById('passwordReg').value;

    fetch(`${apiUrl}/usuario/registro`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({nombre, email, password})
    })
    .then(res => res.json())
    .then(data => {
      if(data.error) {
        showMessage('loginRegistroMessage', data.error);
      } else {
        showMessage('loginRegistroMessage', 'Registro exitoso, ya puedes iniciar sesión.', 'green');
        document.getElementById('registroForm').reset();
      }
    })
    .catch(() => showMessage('loginRegistroMessage', 'Error al conectar con el servidor.'));
  });

  // Login de usuario
  document.getElementById('loginForm').addEventListener('submit', e => {
    e.preventDefault();
    clearMessages();

    const email = document.getElementById('emailLog').value.trim();
    const password = document.getElementById('passwordLog').value;

    fetch(`${apiUrl}/usuario/login`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({email, password})
    })
    .then(res => res.json())
    .then(data => {
      if(data.error) {
        showMessage('loginRegistroMessage', data.error);
      } else {
        usuarioLogueado = data.usuario;
        showMessage('loginRegistroMessage', `Bienvenido ${usuarioLogueado.nombre}`, 'green');
        mostrarProductos();
      }
    })
    .catch(() => showMessage('loginRegistroMessage', 'Error al conectar con el servidor.'));
  });

  // Mostrar CRUD productos y ocultar login/registro
  function mostrarProductos() {
    document.getElementById('loginRegistroContainer').style.display = 'none';
    document.getElementById('productosContainer').style.display = 'block';
    clearMessages();
    loadProducts();
  }

  // Cerrar sesión
  document.getElementById('btnCerrarSesion').addEventListener('click', () => {
    usuarioLogueado = null;
    document.getElementById('loginRegistroContainer').style.display = 'block';
    document.getElementById('productosContainer').style.display = 'none';
    clearMessages();
  });

  // Agregar producto
  document.getElementById('productForm').addEventListener('submit', function(event) {
    event.preventDefault();
    clearMessages();

    const name = document.getElementById('name').value.trim();
    const price = parseFloat(document.getElementById('price').value);

    if (!name) {
      showMessage('message', "El nombre es obligatorio.");
      return;
    }
    if (isNaN(price) || price <= 0) {
      showMessage('message', "Ingresa un precio válido mayor a 0.");
      return;
    }

    fetch(`${apiUrl}/producto`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, price })
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        showMessage('message', data.error);
      } else {
        showMessage('message', "Producto agregado correctamente.", "green");
        document.getElementById('productForm').reset();
        loadProducts();
      }
    })
    .catch(() => {
      showMessage('message', "Error al conectar con el servidor.");
    });
  });

  // Cargar productos
  document.getElementById('btnLoad').addEventListener('click', loadProducts);
  function loadProducts() {
    fetch(`${apiUrl}/productos`)
      .then(response => response.json())
      .then(data => {
        const list = document.getElementById('productList');
        list.innerHTML = '';
        if(data.length === 0) {
          list.innerHTML = '<li>No hay productos aún.</li>';
          return;
        }
        data.forEach(p => {
          const li = document.createElement('li');
          li.textContent = `ID: ${p.id} | ${p.name} - $${p.price.toFixed(2)}`;
          
          // Botones Editar y Eliminar
          const btnEdit = document.createElement('button');
          btnEdit.textContent = 'Editar';
          btnEdit.className = 'btn-small';
          btnEdit.onclick = () => editarProducto(p);

          const btnDelete = document.createElement('button');
          btnDelete.textContent = 'Eliminar';
          btnDelete.className = 'btn-small';
          btnDelete.onclick = () => eliminarProducto(p.id);

          li.appendChild(btnEdit);
          li.appendChild(btnDelete);
          list.appendChild(li);
        });
      })
      .catch(() => showMessage('message', "Error al cargar productos."));
  }

  // Editar producto
  function editarProducto(producto) {
    const nuevoNombre = prompt("Nuevo nombre:", producto.name);
    if (nuevoNombre === null) return;
    if (nuevoNombre.trim() === "") return alert("El nombre no puede estar vacío.");

    const nuevoPrecioStr = prompt("Nuevo precio:", producto.price);
    if (nuevoPrecioStr === null) return;
    const nuevoPrecio = parseFloat(nuevoPrecioStr);
    if (isNaN(nuevoPrecio) || nuevoPrecio <= 0) return alert("Precio inválido.");

    fetch(`${apiUrl}/producto/${producto.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: nuevoNombre, price: nuevoPrecio })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.msg || data.error);
      loadProducts();
    })
    .catch(() => alert("Error al conectar con el servidor."));
  }

  // Eliminar producto
  function eliminarProducto(id) {
    if (!confirm("¿Seguro quieres eliminar este producto?")) return;

    fetch(`${apiUrl}/producto/${id}`, {
      method: 'DELETE'
    })
    .then(res => res.json())
    .then(data => {
      alert(data.msg || data.error);
      loadProducts();
    })
    .catch(() => alert("Error al conectar con el servidor."));
  }
</script>

</body>
</html>
